= Script Python pour l'application IoT
:toc:
:toc-title: Sommaire

== **Équipe G1-A2 :**

- Luca Gaches
- Melvin Bouyssou
- Robin Gourgues
- Nicolas Ho

== Présentation du script Python

Le script Python : 

Le main.py s'occupe de gérer la collecte des données des capteurs AM107 et SolarEdge via MQTT, le traitement des données et la génération de fichiers JSON pour l'interface JavaFX. Les résultats sont d'abord stockés dans des fichiers cache avant d'être écrits dans les fichiers resultatAM107.json et resultatSolar.json, en respectant les fréquences de rafraîchissement des données définies par l'utilisateur. 

== Structure du code

Le script est structuré en plusieurs fonctions principales pour assurer une modularité et une lisibilité du code :

- **Chargement de la configuration** :


La fonction config() s'occupe de charger les paramètres du fichier config.json ou génère une configuration par défaut si le fichier n'existe pas. Les paramètres incluent le serveur MQTT, les topics, les salles, les données souhaitées et la fréquence de rafraîchissement. 

- **Vérification et création des fichiers nécessaires** :
    - Fonction 

verifFichier()

 : Vérifie l'existence des fichiers de résultat, de cache et d'alerte, et les crée s'ils n'existent pas.

- **Gestion de la réception des messages MQTT** :
    - Fonction 

on_message_print(type, message)

 : Traite les messages reçus en fonction du type de capteur (AM107 ou SolarEdge) et dirige le traitement vers les fonctions appropriées.

- **Traitement des données des capteurs AM107** :
    - Fonction 

ecrireCacheAm107(data, fichier)

 : Écrit les données reçues dans le fichier cache pour les capteurs AM107.
    - Fonction 

alerteAM107(room, capteur, valeur)

 : Gère les alertes en cas de dépassement des seuils définis pour les capteurs AM107.

- **Traitement des données des capteurs SolarEdge** :
    - Fonction 

ecrireCacheSolaredge(data, fichier)

 : Écrit les données reçues dans le fichier cache pour les capteurs SolarEdge.

- **Transfert des données du cache vers les fichiers de résultat** :
    - Fonction 

appendCacheToResultatAm107(fichierCache, fichierResultat)

 : Transfère les données du cache AM107 vers le fichier de résultat 

resultatAM107.json

.
    - Fonction 

appendCacheToResultatSolaredge(fichierCache, fichierResultat)

 : Transfère les données du cache SolarEdge vers le fichier de résultat 

resultatSolar.json

.

- **Gestion du cycle d'écriture des données** :
    - Fonction 

ecriture()

 : Lance un timer pour effectuer le transfert des données du cache vers les fichiers de résultat à intervalle régulier en fonction de la fréquence définie.

- **Abonnement aux topics MQTT** :
    - Fonction 

thread_subscribe(type, topic)

 : S'abonne aux topics définis et crée un thread pour chaque abonnement.

- **Gestion des signaux système** :
    - Fonction 

sigterm_handler(signal, frame)

 : Gère l'arrêt du script en cas de réception d'un signal 

SIGTERM

.

== Étapes d'installation

1. **Prérequis** :
    - Python 3.x avec `pip` installé.
    - Bibliothèques Python nécessaires (définies dans 

requirements.txt

).

2. **Cloner le dépôt** :

    ```sh
    git clone <URL_DU_DÉPÔT>
    cd <NOM_DU_RÉPERTOIRE>/IoT/Python
    ```

3. **Créer un environnement virtuel** :

    ```sh
    python -m venv venv
    ```

4. **Activer l'environnement virtuel** :

    - Sous Windows :

        ```sh
        venv\Scripts\activate
        ```

    - Sous Linux/macOS :

        ```sh
        source venv/bin/activate
        ```

5. **Installer les dépendances** :

    ```sh
    pip install -r requirements.txt
    ```

6. **Vérifier la configuration** :
    - Assurez-vous que le fichier 

config.json

 est présent et correctement configuré. Sinon, il sera généré automatiquement avec des valeurs par défaut lors de l'exécution du script.

== Étapes de lancement du code

1. **Naviguer vers le répertoire du script** :

    ```sh
    cd <NOM_DU_RÉPERTOIRE>/IoT/Python
    ```

2. **Activer l'environnement virtuel** (si ce n'est pas déjà fait) :

    - Sous Windows :

        ```sh
        venv\Scripts\activate
        ```

    - Sous Linux/macOS :

        ```sh
        source venv/bin/activate
        ```

3. **Lancer le script Python** :

    ```sh
    python main.py
    ```

4. **Surveillance de l'exécution** :
    - Le script affichera des messages indiquant le chargement de la configuration, l'abonnement aux topics MQTT et la collecte des données.
    - En cas d'erreur ou d'arrêt du script, des messages d'erreur seront affichés pour aider au diagnostic.

== Cas de tests

=== Cas de fonctionnement nominal

- **Collecte des données** :
    - Le script doit collecter les données des capteurs définis dans 

config.json

 et les écrire dans les fichiers 

resultatAM107.json

 et 

resultatSolar.json

 à la fréquence spécifiée.
    - *Capture d'écran* : Affichage en console de la réception des messages MQTT et des transferts de données.

- **Gestion des alertes** :
    - En cas de dépassement des seuils définis pour les capteurs AM107, le script doit écrire les alertes dans le fichier 

alerteAM107.json

.
    - *Capture d'écran* : Affichage de la détection d'une alerte avec les détails du capteur, de la salle et de la valeur mesurée.

=== Cas d'erreurs

- **Absence de configuration** :
    - Si le fichier 

config.json

 est absent, le script génère une configuration par défaut.
    - *Capture d'écran* : Message indiquant la création d'une configuration par défaut.

- **Erreur de connexion au serveur MQTT** :
    - En cas d'impossibilité de se connecter au serveur MQTT, le script affiche un message d'erreur.
    - *Capture d'écran* : Message d'erreur indiquant l'échec de la connexion au serveur MQTT.

- **Problème lors de la réception des messages** :
    - Si un message reçu est invalide ou vide, le script affiche une erreur de réception.
    - *Capture d'écran* : Message d'erreur précisant le problème avec le message reçu.

== Conclusion

Le script Python 

main.py

 est une composante essentielle de l'application IoT, assurant la collecte et le traitement des données en temps réel. Grâce à une architecture modulaire et une gestion efficace des threads et des fichiers, il assure une communication fluide entre les capteurs et l'interface utilisateur JavaFX.